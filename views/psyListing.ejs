<%- include('partials/header') -%>
<link href="/static/tabulator-tables/css/tabulator_modern.min.css" rel="stylesheet">
<script type="text/javascript" src="/static/tabulator-tables/js/tabulator.min.js"></script>
<div class="rf-container-fluid">
    <div class="rf-grid-row rf-grid-row--center rf-grid-row--gutter">
        <div class="rf-col rf-col-xs-10 rf-col-md-8 rf-my-4w">
            <h1>Trouver un psychologue</h1>
              <% if (infos.length) { %>
                <% infos.forEach(function(info) { %>
                  <%- include('partials/notificationInfo', {info: info}) -%>
                <% }) %>
            <% }  %>

            <% if (errors.length) { %>
                <% errors.forEach(function(error) { %>
                  <%- include('partials/notificationError', {error: error}) -%>
                <% }) %>
            <% } %>
            <% if (psyList.length > 0) { %>
            <p>
                Il y a actuellement <%= psyList.length %> partenaires du dispositif d'accompagnement.
            </p>
            <div class="rf-input-group">
                <label class="rf-label" for="lastName-filter-value">Rechercher par nom : </label>
                <input class="rf-input midlength-input" id="lastName-filter-value" type="text" placeholder="Delgado">
            </div>
            <div class="rf-input-group">
                <label class="rf-label" for="address-filter-value">Rechercher votre ville ou code postal : </label>
                <input class="rf-input midlength-input" id="address-filter-value" type="text" placeholder="Amiens ou 80000">
            </div>
            <div id="psy-table"></div>
            <% } %>
        </div>
    </div>
</div>
<!-- Import data as recommended by OWASP :
    https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html#html-entity-encoding
-->
<div id="psy-list" style="display: none;">
    <!-- First HTML-escape the json -->
    <%= JSON.stringify(psyList) %>
</div>
<script>
    var setupFilter = function(fieldName) {
        var filterEl = document.getElementById(fieldName + "-filter-value");
        // Trigger setFilter function with correct parameters
        function updateFilter(){
            table.setFilter(fieldName,'like', filterEl.value);
        }
        filterEl.addEventListener("keyup", updateFilter);
    };
    setupFilter("address");
    setupFilter("lastName");

    var psyListElement = document.getElementById("psy-list");
    var psyList = JSON.parse(psyListElement.textContent);

    var table = new Tabulator("#psy-table", {
        data: psyList, //assign data to table
        langs:{ // http://tabulator.info/docs/4.2/localize#setup
            "fr-fr":{ //French language definition
                "pagination":{
                    "first":"Premi√®re",
                    "first_title":"Premi√®re Page",
                    "last":"Derni√®re",
                    "last_title":"Derni√®re Page",
                    "prev":"Pr√©c√©dent",
                    "prev_title":"Page Pr√©c√©dente",
                    "next":"Suivant",
                    "next_title":"Page Suivante",
                },
                "headerFilters":{
                "default":"Rechercher par adresse", //default header filter placeholder text
                }
            },
        },
        tooltipsHeader:true,
        layout:"fitData",      //fit columns to width of table
        responsiveLayout:"hide",  //hide columns that dont fit on the table //@TODO
        tooltips:true,            //show tool tips on cells
        addRowPos:"top",          //when adding a new row, add it to the top of the table
        history:true,             //allow undo and redo actions on the table
        pagination:"local",       //paginate the data
        paginationSize:10,        //allow XX rows per page of data
        movableColumns:false,      //allow column order to be changed
        resizableRows:false,       //allow row order to be changed
        resizableColumns:false,
        initialSort:[             //set the initial sort order of the data
            {column:"lastName", dir:"asc"},
        ],
        columns:[
            {title:"Nom", field:"lastName", sorter:"string", responsive:0},
            {title:"Pr√©nom(s)", field:"firstNames", sorter:"string", responsive:0},
            {title:"Adresse", field:"address", sorter:"string", maxWidth: 300, responsive:0, formatter:"link", formatterParams:{labelField:"address",urlPrefix:"https://www.openstreetmap.org/search?query=",target:"_blank"}},
            {title:"üìû", field:"phone", sorter:"string", responsive:0, formatter: "link", formatterParams:{labelField:"phone",urlPrefix:"tel:"}},
            {title:"Email", field:"email", sorter:"string", responsive:0, formatter:"link", formatterParams:{labelField:"email",urlPrefix:"mailto://"}},
            {title:"T√©l√©consultation", field:"teleconsultation",  headerTooltip: "T√©l√©consultation", responsive:0,sorter:"string", hozAlign:"center",tooltip: "Est ce que le psychologue accepte la t√©l√©consultation ?", formatter:"tickCross"},
            {title:"Site web", field:"website", sorter:"string", maxWidth:200, responsive:0, formatter:"link", formatterParams:{labelField:"website",urlPrefix:"//",target:"_blank"}},
        ],
        headerFilterPlaceholder:"Rechercher un psychologue" // http://tabulator.info/docs/4.9/filter#header
    });
    table.setLocale("fr-fr");
</script>

<%- include('partials/footer') -%>